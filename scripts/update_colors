#!/bin/bash
set -euo pipefail

cp ./sspi_flask_app/client/static/js/color-map.js /tmp/color-map.js.bak
COLORMAP_BACKUP=/tmp/color-map.js.bak

do_file_update() {
    TMPFILE=$(mktemp)
    sed -i '1,/\}/d' ./sspi_flask_app/client/static/js/color-map.js
    {
        echo "// DO NOT EDIT THIS FILE DIRECTLY! UPDATE VIA scripts/update_colors"
        jq < ./local/sspi-colors.json | sed 's/{/const customCountryColors = {/'
        cat ./sspi_flask_app/client/static/js/color-map.js
    } >| $TMPFILE
    mv $TMPFILE ./sspi_flask_app/client/static/js/color-map.js
}

do_file_update || {
    echo "Failed to update color-map.js"
    cp $COLORMAP_BACKUP ./sspi_flask_app/client/static/js/color-map.js
    exit 1
}
