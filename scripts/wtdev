#!/bin/bash
# Parse command line arguments
RUN_FLASK=false
while [[ $# -gt 0 ]]; do
    case $1 in
        --run)
            RUN_FLASK=true
            shift
            ;;
        *)
            echo "Unknown option: $1"
            echo "Usage: $0 [--run]"
            exit 1
            ;;
    esac
done

echo "Current Directory: $(pwd)"
IS_GIT_WORKTREE=$([[ "$(file .git | cut -d: -f2)" = *"directory"* ]] && echo "false" || echo "true")
echo "Is Git Worktree?: $IS_GIT_WORKTREE"
[[ "$IS_GIT_WORKTREE" = "true" ]] && echo "Worktree Directory: $(git rev-parse --show-toplevel)"
BRANCH=$(git rev-parse --abbrev-ref HEAD)
echo "Branch: $BRANCH"
FLASK_RUN_PORT=$(cat wsgi.py | grep 'app.run(' | sed 's/.*port=//;s/).*//')
echo "FLASK_RUN_PORT: $FLASK_RUN_PORT"
FLASK_RUN_COMMAND="source env/bin/activate && flask run --debug --port $FLASK_RUN_PORT"
echo "FLASK_RUN_COMMAND: $FLASK_RUN_COMMAND"
if [[ "$IS_GIT_WORKTREE" = "true" ]]; then
    ISSUE_NUMBER=$(git branch --show-current | grep -oE '^[0-9]+')
    if [[ -z "$ISSUE_NUMBER" ]]; then
        echo "No issue number found in branch name."
    else
        echo "Issue Number: $ISSUE_NUMBER"
        ISSUE_TITLE="$(gh issue view "$ISSUE_NUMBER" --json number,title -q '(.number | tostring)+ ": " + .title') - Port $FLASK_RUN_PORT"
        echo "Issue Title: $ISSUE_TITLE"
        wezterm cli set-tab-title "$ISSUE_TITLE"
    fi
else
    wezterm cli set-tab-title "Main Branch - Port $FLASK_RUN_PORT"
fi

# Run flask if --run flag was provided
if [ "$RUN_FLASK" = true ]; then
    echo ""
    echo "Starting Flask development server..."
    $FLASK_RUN_COMMAND
fi
