{% extends 'layout.html' %}

{% block content %}
<article class="page-content">
    <section class="page-section">
        <div class="content-container">
            <div class="indicator-table-container">
                <div class="indicator-table-title-controls-box">
                    <h2>SSPI Indicator Table</h2>
                    <div class="indicator-table-control-buttons">
                        <button id="reset-button" class="view-data-btn">Reset View</button>
                        <button id="expand-button" class="view-data-btn">Expand All</button>
                        <button id="collapse-button" class="view-data-btn">Collapse All</button>
                    </div>
                </div>
                <p>Explore the complete structure, definitions, and metadata of
                    the SSPI Policy Indicators and their underlying datasets.
                    Click on indicators to view their constituent datasets and
                    methodological details, or follow links to view data for
                    each indicator.</p>
                
                <div class="-container">
                    {% if indicators_data.error %}
                    <div class="error-message">
                        <p>Error loading indicators: {{ indicators_data.error }}</p>
                    </div>
                    {% else %}
                        {% for pillar in indicators_data.pillars %}
                        <div id="{{ pillar.pillar_code }}" class="pillar-section" data-pillar-code="{{ pillar.pillar_code }}">
                            <div class="indicators-pillar-header">
                                <div class="indicators-pillar-header-content">
                                    <button class="collapse-toggle-btn" aria-label="Toggle pillar">
                                        <span class="collapse-icon">▼</span>
                                    </button>
                                    <div class="pillar-info">
                                        <h3 class="pillar-name">{{ pillar.pillar_name }}</h3>
                                        <a href="/data/pillar/{{ pillar.pillar_code }}" class="view-data-btn">
                                            Pillar Scores
                                        </a>
                                        <span class="pillar-code">{{ pillar.pillar_code }}</span>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="pillar-content" data-expanded="true" data-icode="{{ pillar.pillar_code }}">
                                {% for category in pillar.categories %}
                                <div id="{{ category.category_code }}" class="category-section" data-category-code="{{ category.category_code }}">
                                    <div class="indicators-category-header">
                                        <div class="indicators-category-header-content">
                                            <button class="collapse-toggle-btn" aria-label="Toggle category">
                                                <span class="collapse-icon">▼</span>
                                            </button>
                                            <div class="category-info">
                                                <h4 class="category-name">{{ category.category_name }}</h4>
                                                <a href="/data/category/{{ category.category_code }}" class="view-data-btn">
                                                    Category Scores
                                                </a>
                                                <span class="category-code">{{ category.category_code }}</span>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="indicator-table-category-content" data-expanded="true" data-icode="{{ category.category_code }}">
                                        <div class="indicator-table-indicators-list">
                                            {% if category.indicators %}
                                                {% for indicator in category.indicators %}
                                                  <div class="indicator-item" id="{{ indicator.indicator_code}}" "data-indicator-code="{{ indicator.indicator_code }}">
                                                    <div class="indicators-indicator-header">
                                                        <div class="indicator-info">
                                                            <button class="collapse-toggle-btn" aria-label="Toggle datasets">
                                                                <span class="collapse-icon" style="transform: rotate(-90deg)">▼</span>
                                                            </button>
                                                            <div class="indicator-main-info">
                                                                <h5 class="indicator-name">{{ indicator.indicator_name }}</h5>
                                                                <a href="/data/indicator/{{ indicator.indicator_code }}" class="view-data-btn">
                                                                    Indicator Scores
                                                                </a>
                                                                <span class="indicator-code">{{ indicator.indicator_code }}</span>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    
                                                    <div class="indicator-details" data-expanded="false" data-icode="{{ indicator.indicator_code }}">
                                                        {% if indicator.description %}
                                                        <div class="indicator-description">
                                                            <h6>Description</h6>
                                                            <p>{{ indicator.description }}</p>
                                                        </div>
                                                        {% endif %}
                                                        
                                                        {% if indicator.datasets %}
                                                        <div class="datasets-section">
                                                            <h6>Datasets</h6>
                                                            <div class="datasets-list">
                                                                {% for dataset in indicator.datasets %}
                                                                <div class="dataset-item">
                                                                    <div class="dataset-info">
                                                                        <div class="dataset-header-row">
                                                                            <div class="dataset-name">{{ dataset.dataset_name }}</div>
                                                                            <div class="dataset-code">{{ dataset.dataset_code }}</div>
                                                                        </div>
                                                                        <div class="dataset-description">{{ dataset.description }} </div>
                                                                    </div>
                                                                    <details class="dataset-source">
                                                                        <summary><span class="source-label">Source:</span><span class="source-org">{{ dataset.source.OrganizationCode }}</span></summary>
                                                                        <div class="dataset-source-link-container">
                                                                            <a class="view-data-btn" href="{{ dataset.source.Homepage }}"> {{ dataset.source.OrganizationCode }} Homepage </a>
                                                                            <a class="view-data-btn" href="https://github.com/tjmisko/sspi-data-webapp/blob/main/sspi_flask_app/api/datasource/{{ dataset.source.OrganizationCode | lower }}.py" target="_blank" >{{ dataset.source.OrganizationCode }} API Collector Utility (GitHub)</a>
                                                                            <a class="view-data-btn" href="https://github.com/tjmisko/sspi-data-webapp/blob/main/sspi_flask_app/api/core/datasets/{{ dataset.source.OrganizationCode | lower }}/{{ dataset.dataset_code | lower }}.py" target="_blank" > {{ dataset.dataset_code }} Collector Call (GitHub)</a>
                                                                        </div>
                                                                    </details>
                                                                </div>
                                                                {% endfor %}
                                                            </div>
                                                        </div>
                                                        {% endif %}
                                                    </div>
                                                </div>
                                                {% endfor %}
                                            {% else %}
                                                <div class="no-indicators">
                                                    <em>No indicators available for this category</em>
                                                </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                        {% endfor %}
                    {% endif %}
                </div>
            </div>
        </div>
    </section>
</article>
<script>
const tableState = window.observableStorage.getItem('indicatorTableState')
if ("{{ view_item }}".length > 1 && tableState["{{ view_item }}"]) {
    tableState["{{ view_item }}"] = 'true'
    window.observableStorage.setItem('indicatorTableState', tableState)
}
let indicatorTable = new IndicatorTable();
document.addEventListener('DOMContentLoaded', () => {
    SSPICharts.push(indicatorTable);
});
const expandAll = document.getElementById('expand-button')
expandAll.addEventListener('click', function() {
    indicatorTable.expandAll()
})
const resetView = document.getElementById('reset-button')
resetView.addEventListener('click', function() {
    indicatorTable.resetView()
})
const collapseAll = document.getElementById('collapse-button')
collapseAll.addEventListener('click', function() {
    indicatorTable.collapseAll()
})
</script>
{% endblock %}
