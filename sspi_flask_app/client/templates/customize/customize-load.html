{% extends 'layout.html' %}
{% block content %}
<style>
.load-container {
  display: flex;
  gap: 1.25em;
}

.functionality-explainer {
  color: var(--low-importance-font-color);
  font-family: var(--body-font-family);
}

.active-session-banner {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 1.5rem;
    border-radius: 12px;
    margin-bottom: 2rem;
    box-shadow: 0 4px 6px rgba(0,0,0,0.1);
}

.active-session-banner h3 {
    margin: 0 0 0.5rem 0;
    font-size: 1.25rem;
}

.active-session-banner p {
    margin: 0 0 1rem 0;
    opacity: 0.9;
}

.resume-button {
    background: white;
    color: #667eea;
    border: none;
    padding: 0.75rem 1.5rem;
    border-radius: 6px;
    font-weight: 600;
    cursor: pointer;
    transition: transform 0.2s ease;
}

.resume-button:hover {
    transform: translateY(-2px);
}

.bounded-content-box {
  background-color: var(--box-background-color);
  padding: 1.25rem;
  background-color: var(--box-background-color);
  border-radius: var(--border-radius-lg);
  border: 1px solid var(--border-color);
  box-shadow: var(--shadow-md);
  box-sizing: border-box;
}

.config-section {
  flex: 1 1 0;
}

.config-section h2 {
 font-size: 1.75rem;
 margin-bottom: 0.5rem;
 color: var(--text-primary);
}

.config-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
    gap: 1.5rem;
}

.config-card {
    background: var(--box-background-color);
    border: 1px solid var(--border-color);
    border-radius: 12px;
    padding: 1.5rem;
    transition: all 0.3s ease;
    cursor: pointer;
}

.config-card:hover {
    border-color: var(--primary-color);
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    transform: translateY(-2px);
}

.config-card-header {
    display: flex;
    align-items: flex-start;
    justify-content: space-between;
    margin-bottom: 0.75rem;
}

.config-name {
    font-size: 1.25rem;
    font-weight: 600;
    color: var(--text-primary);
    margin: 0;
}

.config-badge {
    font-size: 0.75rem;
    padding: 0.25rem 0.5rem;
    border-radius: 4px;
    background: var(--primary-color);
    color: white;
    white-space: nowrap;
}

.config-description {
    color: var(--text-secondary);
    font-size: 0.95rem;
    margin-bottom: 1rem;
    line-height: 1.5;
}

.config-meta {
    display: flex;
    align-items: center;
    gap: 1rem;
    font-size: 0.85rem;
    color: var(--text-tertiary);
    margin-bottom: 1rem;
}

.config-meta-item {
    display: flex;
    align-items: center;
    gap: 0.25rem;
}

.config-actions {
    display: flex;
    gap: 0.75rem;
}

.btn-load {
    flex: 1;
    background: var(--primary-color);
    color: white;
    border: none;
    padding: 0.75rem;
    border-radius: 6px;
    font-weight: 600;
    cursor: pointer;
    transition: background 0.2s ease;
}

.btn-load:hover {
    background: var(--primary-hover-color);
}

.btn-secondary {
    background: var(--bg-secondary);
    color: var(--text-primary);
    border: 1px solid var(--border-color);
    padding: 0.75rem 1rem;
    border-radius: 6px;
    cursor: pointer;
    transition: all 0.2s ease;
}

.btn-secondary:hover {
    border-color: var(--primary-color);
    color: var(--primary-color);
}

.loading-message, .empty-message, .error-message {
    text-align: center;
    padding: 3rem;
    color: var(--text-secondary);
    font-style: italic;
}

.error-message {
    color: var(--error-color);
}
</style>
<article class="page-content">
    <section class="page-section">
        <div class="content-container">
            <div class="load-container">
                <div class="bounded-content-box config-section">
                    <h2>Load Prebuilt Configuration</h2>
                    <p class="functionality-explainer">Choose a pre-built SSPI configuration or load one of your saved customizations.</p>

                    <div class="config-grid">
                        {% for config in prebuilt_configurations %}
                            <div class="config-card" data-config-id="{{ config.id }}" data-config-type="prebuilt">
                                <div class="config-card-header">
                                    <h3 class="config-name">{{ config.name }}</h3>
                                    {% if config.recommended %}
                                    <span class="config-badge">Recommended</span>
                                    {% endif %}
                                </div>
                                <p class="config-description">{{ config.description }}</p>
                                <div class="config-meta">
                                    <span class="config-meta-item">{{ config.pillars }} Pillars</span>
                                    <span class="config-meta-item">{{ config.categories }} Categories</span>
                                    <span class="config-meta-item">{{ config.indicators }} Indicators</span>
                                </div>
                                <div class="config-actions">
                                    <button class="btn-load" onclick="loadConfiguration('{{ config.id }}', 'prebuilt')">Load</button>
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                </div>
                <!-- Saved Configurations -->
                <div class="bounded-content-box config-section">
                    {% if active_session %}
                    <div class="active-session-banner">
                        <h3>You have an active editing session</h3>
                        <p>{{ active_session.name }} - Last activity: {{ active_session.last_activity }}</p>
                        <button class="resume-button" onclick="window.location.href='/customize/builder'">
                            Resume Session
                        </button>
                    </div>
                    {% endif %}
                    <h2>Your Saved Configurations</h2>
                    <div class="config-grid">
                        {% if not is_authenticated %}
                            <!-- Authentication Required Message -->
                            <div class="auth-required-message" style="text-align: center; padding: 3rem; background: #f8f9fa; border-radius: 8px; border: 2px dashed #dee2e6;">
                                <h3 style="color: #6c757d; margin-bottom: 1rem;">Log In to View Saved Configurations</h3>
                                <p style="color: #868e96; margin-bottom: 1.5rem;">Sign in to access your saved custom SSPI structures</p>
                                <div>
                                    <a href="/login" class="btn btn-primary" style="margin-right: 1rem;">Log In</a>
                                    <a href="/register" class="btn btn-secondary">Create Free Account</a>
                                </div>
                            </div>
                        {% elif saved_configurations|length == 0 %}
                            <!-- Empty State -->
                            <div class="empty-message">No saved configurations yet. Start by building a custom SSPI!</div>
                        {% else %}
                            <!-- Render Saved Configuration Cards -->
                            {% for config in saved_configurations %}
                            <div class="config-card" data-config-id="{{ config.id }}">
                                <div class="config-card-header">
                                    <h3 class="config-name">{{ config.name or 'Unnamed Configuration' }}</h3>
                                </div>
                                <p class="config-description">{{ config.description or 'Custom SSPI configuration' }}</p>
                                {% if config.updated_at %}
                                <div class="config-meta">
                                    <span class="config-meta-item">{{ config.updated_at }}</span>
                                </div>
                                {% endif %}
                                <div class="config-actions">
                                    <button class="btn-load" onclick="loadConfiguration('{{ config.id }}', 'saved')">Load</button>
                                    <button class="btn-secondary" onclick="deleteConfiguration('{{ config.id }}')">üóëÔ∏è</button>
                                </div>
                            </div>
                            {% endfor %}
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </section>
</article>
<script>
    // CSRF token from backend - used by bundled csrf.js utility
    window.csrfToken = {{ csrf_token|tojson|safe }};

    // Load configuration and start editing session
    async function loadConfiguration(configId, type) {
        try {
            const endpoint = type === 'prebuilt'
                ? `/api/v1/customize/prebuilt/${configId}`
                : `/api/v1/customize/load/${configId}`;

            const response = await fetch(endpoint);
            const data = await response.json();

            if (data.success && data.metadata) {
                // Start a new session with this configuration
                await window.csrf.fetchWithCSRF('/api/v1/customize/session/start', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        config_id: configId,
                        name: data.metadata[0]?.name || 'SSPI',
                        metadata: data.metadata
                    })
                });

                // Redirect to builder
                window.location.href = '/customize/builder';
            } else {
                alert('Error loading configuration: ' + (data.error || 'Unknown error'));
            }
        } catch (error) {
            console.error('Error loading configuration:', error);
            alert('Error loading configuration. Please try again.');
        }
    }

    async function deleteConfiguration(configId) {
        if (!confirm('Are you sure you want to delete this configuration?')) {
            return;
        }

        try {
            const response = await window.csrf.fetchWithCSRF(`/api/v1/customize/delete/${configId}`, {
                method: 'DELETE'
            });
            const data = await response.json();

            if (data.success) {
                // Reload page to show updated list
                window.location.reload();
            } else {
                alert('Error deleting configuration: ' + (data.error || 'Unknown error'));
            }
        } catch (error) {
            console.error('Error deleting configuration:', error);
            alert('Error deleting configuration. Please try again.');
        }
    }
</script>
{% endblock %}
