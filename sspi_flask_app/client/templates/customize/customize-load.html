{% extends 'layout.html' %}
{% block content %}
<article class="page-content">
    <section class="page-section">
        <!-- Unsaved warnings will be injected here by JavaScript -->
        <div id="unsaved-warnings-container" class="unsaved-warnings-section"></div>

        <div class="load-container">
            <div class="bounded-content-box config-section">
                <h3>Load Prebuilt Configuration</h3>
                <p class="functionality-explainer">
                    Choose a preset SSPI configuration to start from. Useful for comparing
                    a series of changes to the original SSPI and for running sensitivity testing.
                </p>
                <div class="config-flex-container">
                    {% for config in prebuilt_configurations %}
                        <div class="config-card" data-config-id="{{ config.id }}" data-config-type="prebuilt">
                            <div class="config-card-header">
                                <h3 class="config-name">{{ config.name }}</h3>
                                {% if config.recommended %}
                                <span class="config-badge">Recommended</span>
                                {% endif %}
                            </div>
                            <p class="config-description">{{ config.description }}</p>
                            <div class="config-meta">
                                <span class="config-meta-item">{{ config.pillars }} Pillars</span>
                                <span class="config-meta-item">{{ config.categories }} Categories</span>
                                <span class="config-meta-item">{{ config.indicators }} Indicators</span>
                                <span class="config-meta-item">{{ config.datasets }} Datasets</span>
                            </div>
                            <div class="config-actions">
                                <a href="/customize/builder?base_config={{ config.id }}" class="btn-load">Load</a>
                            </div>
                        </div>
                    {% endfor %}
                </div>
            </div>
            <!-- Saved Configurations -->
            <div class="bounded-content-box config-section">
                <h3>Saved Configurations</h3>
                <p class="functionality-explainer">
                    Load a custom SSPI configuration to view scores, comparisons with the canonical SSPI, or resume editing.
                </p>
                <div class="config-flex-container">
                    {% if not is_authenticated %}
                        {% include 'components/login-box.html' with context %}
                    {% elif saved_configurations | length == 0 %}
                        <div class="empty-message">No saved configurations yet. Start by building a custom SSPI!</div>
                    {% else %}
                        {% for config in saved_configurations %}
                        <div class="config-card" data-config-id="{{ config.id }}">
                            <div class="config-card-header">
                                <h3 class="config-name">{{ config.name }}</h3>
                            </div>
                            <p class="config-description">{{ config.description or 'Custom SSPI configuration' }}</p>
                            {% if config.updated_at %}
                            <div class="config-meta">
                                <span class="config-meta-item">{{ config.updated_at }}</span>
                            </div>
                            {% endif %}
                            <div class="config-actions">
                                <a href="/customize/builder?base_config={{ config.id }}" class="btn-load">Load</a>
                            </div>
                        </div>
                        {% endfor %}
                    {% endif %}
                </div>
            </div>
            <div class="bounded-content-box config-section">
                <h3>New Configuration</h3>
                <p class="functionality-explainer">
                    Begin from an empty template, designing your own
                    data-driven policy index from the datasets up.
                </p>
                <div class="config-flex-container">
                    <div class="config-card">
                        <div class="config-card-header">
                            <h3 class="config-name">Blank Configuration</h3>
                        </div>
                        <p class="config-description">
                            Start with an empty template and build your custom policy index
                            from scratch, selecting your own datasets, indicators, and scoring methods.
                        </p>
                        <div class="config-actions">
                            <a href="/customize/builder?base_config=blank" class="btn-load">Start Building</a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>
</article>
<script>
window.csrfToken = {{ csrf_token|tojson|safe }};
window.sspiUsername = {{ current_user.username|tojson|safe if current_user.is_authenticated else '""' }};

// Check for unsaved changes on page load
document.addEventListener('DOMContentLoaded', () => {
    checkForUnsavedChanges();
});

/**
 * Check localStorage for any cached configurations with unsaved changes
 * and display warning banners for each one
 */
function checkForUnsavedChanges() {
    if (!window.sspiUsername) return;

    try {
        const userCachePattern = `customSSPI_${window.sspiUsername}_`;
        const unsavedConfigs = [];

        // Scan all localStorage keys for user's cached configs
        for (let i = 0; i < localStorage.length; i++) {
            const key = localStorage.key(i);
            if (key && key.startsWith(userCachePattern)) {
                const cacheData = JSON.parse(localStorage.getItem(key));
                if (cacheData && cacheData.hasModifications) {
                    const baseConfig = key.replace(userCachePattern, '');
                    unsavedConfigs.push({
                        baseConfig: baseConfig,
                        lastModified: cacheData.timestamp,
                        configName: getConfigName(baseConfig)
                    });
                }
            }
        }

        if (unsavedConfigs.length > 0) {
            displayUnsavedWarnings(unsavedConfigs);
        }
    } catch (error) {
        console.error('Error checking for unsaved changes:', error);
    }
}

/**
 * Get a human-readable name for a base_config ID
 */
function getConfigName(baseConfig) {
    const prebuiltNames = {
        'sspi': 'Standard SSPI',
        'blank': 'Blank Configuration',
        'default': 'Default SSPI'
    };
    return prebuiltNames[baseConfig] || `Configuration ${baseConfig}`;
}

/**
 * Display warning banners for configurations with unsaved changes
 */
function displayUnsavedWarnings(unsavedConfigs) {
    const container = document.getElementById('unsaved-warnings-container');
    if (!container) return;

    const html = unsavedConfigs.map(config => `
        <div class="unsaved-warning-banner">
            <h4>Unsaved Changes in ${config.configName}</h4>
            <p>Last modified: ${new Date(config.lastModified).toLocaleString()}</p>
            <div class="warning-actions">
                <a href="/customize/builder?base_config=${config.baseConfig}" class="btn-primary">
                    Resume Editing
                </a>
                <button class="btn-secondary" onclick="discardCache('${config.baseConfig}')">
                    Discard Changes
                </button>
            </div>
        </div>
    `).join('');

    container.innerHTML = html;
}

/**
 * Discard cached changes for a specific base_config
 */
function discardCache(baseConfig) {
    if (!confirm(`Discard all unsaved changes to ${getConfigName(baseConfig)}?`)) {
        return;
    }

    try {
        const username = window.sspiUsername;
        const cacheKey = `customSSPI_${username}_${baseConfig}`;
        localStorage.removeItem(cacheKey);
        window.location.reload();
    } catch (error) {
        console.error('Error discarding cache:', error);
        alert('Error discarding changes. Please try again.');
    }
}

async function deleteConfiguration(configId) {
    if (!confirm('Are you sure you want to delete this configuration?')) {
        return;
    }

    try {
        const response = await window.csrf.fetchWithCSRF(`/api/v1/customize/delete/${configId}`, {
            method: 'DELETE'
        });
        const data = await response.json();

        if (data.success) {
            // Reload page to show updated list
            window.location.reload();
        } else {
            alert('Error deleting configuration: ' + (data.error || 'Unknown error'));
        }
    } catch (error) {
        console.error('Error deleting configuration:', error);
        alert('Error deleting configuration. Please try again.');
    }
}
</script>
{% endblock %}
