{% extends 'layout.html' %}

{% block stylesheet %}
<meta name="csrf-token" content="{{ csrf_token }}">
{% endblock %}

{% block content %}
<div class="customizable-sspi" id="sspi-root"
     data-username="{{ current_user.username }}"
     data-active-session="{{ active_session|tojson if active_session else '{}' }}">
</div>

<script>
if (!window.csrf) {
    window.csrf = {
        getToken: function() {
            const metaTag = document.querySelector('meta[name="csrf-token"]');
            return metaTag ? metaTag.getAttribute('content') : null;
        },
        fetchWithCSRF: async function(url, options = {}) {
            const csrfToken = this.getToken();
            const method = (options.method || 'GET').toUpperCase();
            const needsCSRF = ['POST', 'PUT', 'DELETE', 'PATCH'].includes(method);

            if (needsCSRF && csrfToken) {
                options.headers = {
                    ...options.headers,
                    'X-CSRFToken': csrfToken
                };
            }

            return fetch(url, options);
        }
    };
}
window.sspiUsername = "{{ current_user.username }}";
window.sspiActiveSession = {{ active_session|tojson|safe if active_session else 'null' }};
document.addEventListener('DOMContentLoaded', () => {
    const root = document.getElementById('sspi-root');
    window.SSPICharts.push(
        new CustomizableSSPIStructure(root, {
            username: window.sspiUsername,
            activeSession: window.sspiActiveSession
        })
    );
    window.customSSPI = SSPICharts[0];
});
</script>
{% endblock %}

{% block javascript %}
{% endblock %}
