<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Custom SSPI Chart Test</title>
    
    <!-- CSS Dependencies -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/variables.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/base.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/charts/panel-chart.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/charts/sspi-panel-chart.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/charts/custom-sspi-panel-chart.css') }}">
    
    <!-- Chart.js -->
    <script src="{{ url_for('static', filename='dist/chart.umd.min.js') }}"></script>
    
    <!-- Papa Parse for CSV handling -->
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.0/papaparse.min.js"></script>
    
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: var(--spacing-lg);
            background-color: var(--background-primary);
            color: var(--text-primary);
        }
        
        .test-container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .test-header {
            text-align: center;
            margin-bottom: var(--spacing-xl);
        }
        
        .test-header h1 {
            color: var(--text-primary);
            margin-bottom: var(--spacing-sm);
        }
        
        .test-header p {
            color: var(--text-secondary);
            font-size: 1.1em;
        }
        
        .config-selector {
            background-color: var(--panel-background);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            padding: var(--spacing-md);
            margin-bottom: var(--spacing-lg);
        }
        
        .config-selector h3 {
            margin: 0 0 var(--spacing-md) 0;
            color: var(--text-primary);
        }
        
        .config-form {
            display: flex;
            gap: var(--spacing-md);
            align-items: end;
            flex-wrap: wrap;
        }
        
        .config-form div {
            display: flex;
            flex-direction: column;
            gap: var(--spacing-xs);
        }
        
        .config-form label {
            font-weight: 600;
            color: var(--text-primary);
            font-size: 0.9em;
        }
        
        .config-form input,
        .config-form select {
            padding: var(--spacing-sm);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius-sm);
            background-color: var(--input-background);
            color: var(--text-primary);
            font-size: 0.9em;
        }
        
        .config-form button {
            padding: var(--spacing-sm) var(--spacing-md);
            background-color: var(--color-primary);
            color: white;
            border: 1px solid var(--color-primary);
            border-radius: var(--border-radius-sm);
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .config-form button:hover {
            background-color: var(--color-primary-dark);
        }
        
        #chart-container {
            min-height: 800px;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            background-color: var(--panel-background);
        }
        
        .error-display {
            background-color: var(--color-error-light);
            border: 1px solid var(--color-error);
            border-radius: var(--border-radius);
            padding: var(--spacing-md);
            margin-bottom: var(--spacing-lg);
            color: var(--color-error-dark);
        }
        
        .error-display h4 {
            margin: 0 0 var(--spacing-sm) 0;
        }
        
        .debug-info {
            background-color: var(--background-secondary);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            padding: var(--spacing-md);
            margin-top: var(--spacing-lg);
            font-family: 'Monaco', 'Consolas', monospace;
            font-size: 0.85em;
            color: var(--text-secondary);
        }
        
        .debug-info h4 {
            margin: 0 0 var(--spacing-sm) 0;
            color: var(--text-primary);
            font-family: inherit;
        }
        
        .debug-info pre {
            margin: 0;
            white-space: pre-wrap;
            word-break: break-all;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <div class="test-header">
            <h1>Custom SSPI Panel Chart Test</h1>
            <p>Test interface for the custom SSPI scoring and visualization pipeline</p>
        </div>
        
        <div class="config-selector">
            <h3>Configuration Selection</h3>
            <div class="config-form">
                <div>
                    <label for="config-id">Configuration ID:</label>
                    <input type="text" id="config-id" placeholder="Enter config ID or select from list">
                </div>
                <div>
                    <label for="config-list">Or Select Existing:</label>
                    <select id="config-list">
                        <option value="">Loading configurations...</option>
                    </select>
                </div>
                <div>
                    <button onclick="loadChart()" id="load-btn">Load Chart</button>
                </div>
            </div>
        </div>
        
        <div id="error-container" class="error-display" style="display: none;">
            <h4>Error</h4>
            <p id="error-message"></p>
        </div>
        
        <div id="chart-container">
            <div style="display: flex; align-items: center; justify-content: center; height: 400px; color: var(--text-secondary);">
                <p>Select a configuration above to load the custom SSPI chart</p>
            </div>
        </div>
        
        <div id="debug-info" class="debug-info" style="display: none;">
            <h4>Debug Information</h4>
            <pre id="debug-content"></pre>
        </div>
    </div>
    
    <!-- Include SVG Icons -->
    <svg style="display: none;">
        <defs>
            <g id="icon-close">
                <path d="M4.646 4.646a.5.5 0 0 1 .708 0L8 7.293l2.646-2.647a.5.5 0 0 1 .708.708L8.707 8l2.647 2.646a.5.5 0 0 1-.708.708L8 8.707l-2.646 2.647a.5.5 0 0 1-.708-.708L7.293 8 4.646 5.354a.5.5 0 0 1 0-.708z"/>
            </g>
            <g id="icon-menu">
                <path fill-rule="evenodd" d="M2.5 12a.5.5 0 0 1 .5-.5h10a.5.5 0 0 1 0 1H3a.5.5 0 0 1-.5-.5zm0-4a.5.5 0 0 1 .5-.5h10a.5.5 0 0 1 0 1H3a.5.5 0 0 1-.5-.5zm0-4a.5.5 0 0 1 .5-.5h10a.5.5 0 0 1 0 1H3a.5.5 0 0 1-.5-.5z"/>
            </g>
        </defs>
    </svg>
    
    <!-- Chart Plugin Dependencies -->
    <script src="{{ url_for('static', filename='charts/plugins/chart-interaction-plugin.js') }}"></script>
    <script src="{{ url_for('static', filename='js/extrapolate-backward-plugin.js') }}"></script>
    <script src="{{ url_for('static', filename='js/sspi-colors.js') }}"></script>
    <script src="{{ url_for('static', filename='js/sspi-item-tree.js') }}"></script>
    <script src="{{ url_for('static', filename='js/country-selector.js') }}"></script>
    <script src="{{ url_for('static', filename='js/observable-storage.js') }}"></script>
    
    <!-- Chart Component Dependencies -->
    <script src="{{ url_for('static', filename='charts/panel/panel-chart.js') }}"></script>
    <script src="{{ url_for('static', filename='charts/panel/sspi-panel-chart.js') }}"></script>
    <script src="{{ url_for('static', filename='charts/panel/custom-sspi-panel-chart.js') }}"></script>
    
    <script>
        let currentChart = null;
        let debugMode = false;
        
        // Initialize the page
        document.addEventListener('DOMContentLoaded', function() {
            loadConfigurations();
            
            // Setup debug mode toggle (ctrl+shift+D)
            document.addEventListener('keydown', function(e) {
                if (e.ctrlKey && e.shiftKey && e.key === 'D') {
                    debugMode = !debugMode;
                    const debugInfo = document.getElementById('debug-info');
                    debugInfo.style.display = debugMode ? 'block' : 'none';
                    console.log('Debug mode:', debugMode ? 'enabled' : 'disabled');
                }
            });
            
            // Setup config list change handler
            document.getElementById('config-list').addEventListener('change', function() {
                const configId = this.value;
                if (configId) {
                    document.getElementById('config-id').value = configId;
                }
            });
        });
        
        async function loadConfigurations() {
            try {
                const response = await fetch('/api/v1/customize/list');
                const data = await response.json();
                
                if (data.success) {
                    const select = document.getElementById('config-list');
                    select.innerHTML = '<option value="">Select a configuration...</option>';
                    
                    data.configurations.forEach(config => {
                        const option = document.createElement('option');
                        option.value = config.config_id;
                        option.textContent = `${config.name} (${config.config_id})`;
                        select.appendChild(option);
                    });
                    
                    logDebug('Loaded configurations', data.configurations);
                } else {
                    throw new Error(data.error || 'Failed to load configurations');
                }
                
            } catch (error) {
                console.error('Error loading configurations:', error);
                showError('Failed to load configurations: ' + error.message);
                
                const select = document.getElementById('config-list');
                select.innerHTML = '<option value="">Error loading configurations</option>';
            }
        }
        
        async function loadChart() {
            const configId = document.getElementById('config-id').value.trim();
            
            if (!configId) {
                showError('Please enter or select a configuration ID');
                return;
            }
            
            hideError();
            logDebug('Loading chart for config', configId);
            
            try {
                // Clear existing chart
                if (currentChart) {
                    const container = document.getElementById('chart-container');
                    container.innerHTML = '<div style="display: flex; align-items: center; justify-content: center; height: 400px; color: var(--text-secondary);"><p>Loading chart...</p></div>';
                    currentChart = null;
                }
                
                // Create new custom chart
                currentChart = new CustomSSPIPanelChart(
                    document.getElementById('chart-container'),
                    configId,
                    {
                        CountryList: [], // Empty list means all available countries
                        width: 1000,
                        height: 600
                    }
                );
                
                logDebug('Custom chart created', {
                    configId: configId,
                    chart: currentChart
                });
                
            } catch (error) {
                console.error('Error creating chart:', error);
                showError('Failed to create chart: ' + error.message);
                logDebug('Chart creation error', error);
            }
        }
        
        function showError(message) {
            const errorContainer = document.getElementById('error-container');
            const errorMessage = document.getElementById('error-message');
            
            errorMessage.textContent = message;
            errorContainer.style.display = 'block';
            
            // Auto-hide after 10 seconds
            setTimeout(() => {
                hideError();
            }, 10000);
        }
        
        function hideError() {
            const errorContainer = document.getElementById('error-container');
            errorContainer.style.display = 'none';
        }
        
        function logDebug(message, data = null) {
            if (!debugMode) return;
            
            const debugContent = document.getElementById('debug-content');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${message}${data ? ': ' + JSON.stringify(data, null, 2) : ''}`;
            
            debugContent.textContent += logEntry + '\n\n';
            debugContent.scrollTop = debugContent.scrollHeight;
            
            console.log(`[CustomChart] ${message}`, data);
        }
        
        // Global error handler
        window.addEventListener('error', function(e) {
            logDebug('JavaScript error', {
                message: e.message,
                filename: e.filename,
                lineno: e.lineno,
                colno: e.colno,
                error: e.error?.toString()
            });
        });
        
        // Global unhandled promise rejection handler
        window.addEventListener('unhandledrejection', function(e) {
            logDebug('Unhandled promise rejection', {
                reason: e.reason?.toString()
            });
        });
    </script>
</body>
</html>